name: Sync main → staging

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Buscar branches remotas
        run: |
          git fetch --all --prune
          if git ls-remote --heads origin staging | grep -q staging; then
            git fetch origin staging:staging
          else
            git branch staging origin/main
            git push -u origin staging
          fi

      - name: Tentar merge main → staging
        id: merge
        shell: bash
        run: |
          set -e
          git checkout staging
          # Tentativa de merge; não falha o job, apenas registra o resultado
          set +e
          git merge --no-ff --no-edit origin/main
          status=$?
          set -e
          if [ $status -eq 0 ]; then
            echo "result=merged" >> "$GITHUB_OUTPUT"
          else
            echo "result=conflict" >> "$GITHUB_OUTPUT"
          fi

      - name: Push para staging
        if: steps.merge.outputs.result == 'merged'
        id: push
        run: |
          set +e
          git push origin HEAD:staging
          status=$?
          set -e
          if [ $status -ne 0 ]; then
            echo "push_blocked=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Abrir PR (conflito ou push bloqueado)
        if: steps.merge.outputs.result == 'conflict' || steps.push.outputs.push_blocked == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Cria/reativa PR de main → staging
          existing=$(gh pr list --base staging --head main --state open --json number --jq '.[0].number')
          if [ -n "$existing" ]; then
            gh pr comment "$existing" --body "Atualização automática: houve conflito ou proteção de branch ao sincronizar $GITHUB_SHA."
          else
            gh pr create \
              --base staging \
              --head main \
              --title "Sync main → staging" \
              --body "PR automático: conflito no merge ou proteção da branch impediu push direto. Commit: $GITHUB_SHA"
          fi
